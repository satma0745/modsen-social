# Ревью от Максима


## Содержание

 - [Ревью](#Ревью)
 - [Предпосылки и выводы](#Предпосылки-и-выводы)
 - [Конкретные проблемы и их исправление](#Конкретные-проблемы-и-их-исправление)


## Ревью

Привет, просмотрел твой сервер, есть вопросы пока по структуре, как-то все запутанно.
У тебя есть файл shared, никто не поймет что это за шаред и почему он в роутах, больше похоже что это utils и эта 
папка по логике должна быть в корне.
Почему в роутах у тебя все в перемешку и там и схемы которые по идеи должны лежать в схемах, и бизнес логика которую
можно вынести в сервисы.
Mappers лучше поменять на dto, потому что у тебя они и лежат там.
Eсли ты хочешь сделать все одной папке то раздели ее как-то чтобы было понятно (modules > user > [user.controller.js,
user.model.js, user.service.js, …]), либо сделать папки раздельные.
По поводу функции handleAsync, называется вроде про обработку асинхрона, но по факту там валидация внутри, либо я не 
так понял, да и зачем она тебе как обертка всех функций, разве нельзя сделать middleware и не использовать эту обертку
на каждом роуте, в просто вставлять ее в роут через запятую с нужным конфигом валидации? Можно не вызывать 
requestHandler а написать просто next() и вызов пойдет дальше по цепочке.
Пока как-то так, посмотри лучше как структуру правильно делать и какие слои бывают, конечно у всех 
разные варианты, и зависят они от ситуации, но у тебя выглядит запутанно пока что.


## Предпосылки и выводы

Задание было дано в контексте проверки наличия навыков использования nodejs и сопутствующих инструментов (в данном 
случае express, mongoose, swagger, etc.).
Пытался реализовать решение проблемы максимально быстро с расчётом на то, что в следующем более сложном задании 
можно будет попробовать написать что-то более качественное и интересное.
В _жертву_ были принесены общая архитектура приложения (всё свалено в кучу), реализация авторизации (есть
только долгоживущий аксесс токен), работа с базой данных (нет миграций), версирование и прочее.

Все вопросы касаются архитектуры, что говорит о том, что архитектура не позволяет полноценно ориентироваться в коде 
и понимать, что в нём происходит.
В частности небыли подняты вопросы того об организации авторизации, миграций, версий и прочего.
Проблема неверного выбранного архитектурного подхода должна быть решена.
Впредь, в подобной ситуации, **не буду оставлять без внимания архитектуру** приложения.


## Конкретные проблемы и их исправление

### Список
 - [Общая запутанность](#Общая-запутанность)
 - [Shared utils](#Shared-utils)
 - [Mappers VS Dtos](#Mappers-VS-Dtos)
 - [handleAsync](#handleAsync)

### Общая запутанность

Как уже было указано в выводах, нельзя пренебрегать архитектурой.
Решением проблемы выбранного подхода является разделение логики между схемами, раутами, спекой, мапперами и 
сервисами в рамках feature/use-case/context.
Описание структуры:
 - `contoller.js` содержит api action handlers: подготовка данных, вызов метода сервиса, маппинг ответа сервиса в 
дто, OpenApi спека
 - `dtos.js` содержит мапперы `Mongodb Document -> DTO`
 - `schemas.js` содержит схемы валидации
 - `service.js` содержит бизнес-логику
Выбранная структура:
```
src
└── features
    ├── auth
    │   ├── controller.js
    │   ├── dtos.js
    │   ├── schemas.js
    │   └── service.js
    ├── profile
    │   ├── controller.js
    │   ├── dtos.js
    │   ├── schemas.js
    │   └── service.js
    └── users
        ├── controller.js
        ├── dtos.js
        ├── schemas.js
        └── service.js
```

### Shared utils

В файл `shared.js` были свалены все утилиты: схемы валидации и санитайзеры общего назначения и конкретно для `ObjectId`, 
middleware для jwt аутентификации, `handleAsync` и маппер `validationErrors -> response`.
Также в замешательство вводило имя _shared_, хотя внутри находятся _утилиты_.
Решением является разделение shared на части, в зависимости от того, для чего они используются. Также необходимо 
переименовать shared в utils:
```
src
└── features
    └── utils
        ├── controller.js
        │   │ * Middlewares
        │   ├── jwt auth middleware
        │   └── validation middleware
        ├── schemas.js
        │   │ * Validation schemas & sanitizers
        │   ├── ObjectId validation schema
        │   ├── ObjectId sanitizer
        │   └── ofType validation schema
        └── service.js
            │ * Service response creators
            ├── success
            ├── conflict
            ├── validationError
            ├── accessViolation
            └── notFound
```


### Mappers VS Dtos

С этим пунктом всё довольно просто, думал что название mappers будет лучше подходить мапперам `MondoDB document -> dto`,
но если это имя только больше путает, то его следует сменить.

### handleAsync

Изначально `handleAsync` использовался для организации отлова ошибок в асинхронном коде (как оказалось, если ошибка 
была выброшена в асинхронном коде, то `express error handlers` её проигнорируют).
От этого решения я так и не ушёл, однако сейчас для этого использую стороннюю библиотеку (`express-async-handler`), 
предоставляющую такую обёртку.
По поводу валидации внутри handleAsync, это реально косяк. Я не знаю, почему я решил запихнуть её туда вместо того, 
что бы просто оборачивать схемы в валидирующий middleware (`validateWith` в утилитах для контроллеров).